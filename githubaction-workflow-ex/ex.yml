name: NestJS CI/CD

on:
  push:     # push or pr ì´ë²¤íŠ¸ê°€ ì´ë£¨ì–´ ì¡Œì„ë•Œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸
  pull_request: 

jobs:
  # ciì— ê²½ìš°
  ci:
    runs-on: ubuntu-latest # ìš°ë¶„íˆ¬ ê°€ìƒ í™˜ê²½ì„ ì‚¬ìš©

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: NestJS ë¹Œë“œ
        run: npm run build # build
 
      - name: Jest í…ŒìŠ¤íŠ¸
        run: npm test # test

  # testìš© develope ë¸ŒëŸ°ì¹˜ê°€ ì—…ë°ì´íŠ¸ ë ë•Œ ì‚¬ìš©
  cd_develop:
    needs: ci # ì´ê±´ í•´ì•¼ cdê°€ ê°€ëŠ¥ 
    runs-on: ubuntu-latest

    # if ë¬¸ì„ ì‚¬ìš©í•´ì„œ brancdhì™€ event ì´ë¦„ì„ ì²´í‚¹í•  ìˆ˜ ìˆë‹¤.
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'

    steps:
      - name: ë°°í¬ìš© ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: develop í™˜ê²½ CD ì‹¤í–‰ (ìŠ¤í…Œì´ì§• ë°°í¬)
        run: |
          echo "ğŸš€ develop ë¸Œëœì¹˜ë¡œ í–¥í•˜ëŠ” PRì…ë‹ˆë‹¤."
          echo "ì—¬ê¸°ì„œ Docker build + push, ìŠ¤í…Œì´ì§• ì„œë²„ ë°°í¬ ë“±ì„ ì‹¤í–‰í•˜ì„¸ìš”."
          # ì˜ˆì‹œ:
          # docker build -t myapp:staging .
          # docker push my-registry/myapp:staging
          # sshë¥¼ ì´ìš©í•´ì„œ ncpì— ì ‘ì† í›„ build ( ipì™€ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•˜ë‹¤. )

  # ë°°í¬ìš© 
  cd_main:
    needs: ci
    runs-on: ubuntu-latest

    # pull_request ì´ë©´ì„œ, PRì˜ íƒ€ê²Ÿ ë¸Œëœì¹˜ê°€ mainì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    steps:
      - name: ë°°í¬ìš© ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: main í™˜ê²½ CD ì‹¤í–‰ ë°°í¬
        run: |
          echo "ğŸš€ main ë¸Œëœì¹˜ë¡œ í–¥í•˜ëŠ” PRì…ë‹ˆë‹¤."
          echo "ì—¬ê¸°ì—ì„œ ì‹¤ì œ Docker ê¸°ë°˜ í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
          # ì˜ˆì‹œ:
          # docker build -t myapp:prod .
          # docker push my-registry/myapp:prod
          # sshë¡œ ì ‘ì†í›„ -> docker compose pull && up -d ì„ ì´ìš©í•´ì„œ ì²˜ë¦¬ 
